---
title: "CNVC_ELC_Practical_Session_01.1"
author: "Aaron Wells"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The data set includes plots from 4 ecoregions: Boreal Plain, Boreal Shield, Prairie, and Boreal Shield. For the purposes of the workshop we'll work on the Boreal Shield subset.

### Subset the environment data 

```{r}

env_ts <- fec_envfor[fec_envfor$ecoregion_title == "Boreal Shield",]

dim(env_ts)

# Another way to subset the environment data would be to use the dplyr filter function

env_ts_dplyr <- filter(fec_envfor,ecoregion_title == "Boreal Shield")

dim(env_ts_dplyr)       

```

### Subsetting the Boreal Shield dataset based on species dominance and environmental attributes

```{r}

table(env_ts$dominanttree)

table(env_ts$dominanttree,env_ts$soil_moisture_agg)
```

The Boreal Shield subset has plots dominated by six species. Black spruce is the common dominant species and it also spans a wide range soil moisture regimes from dry to wet. White spruce, balsam poplar, and quaking aspen all have low sample sizes in the Boreal Shield subset. While it is certainly worthwhile to evaluate plots dominated by those species within the context of the Boreal Shield ecoregion, combining those plots with plots dominated by each respective species in the adjacent ecoregion (Boreal Shield) is recommended to increase the sample size and evaluate the environmental gradients driving the floristic composition in those forest types across the ecoregions. 

For the purposes of this workshop, we'll analyze the subset of plots dominated by black spruces in the dry, fresh, and moist moisture regimes. 

### Create the environment data subset black spruce plots in the Boreal Shield ecoregion

```{r}

env_bs <- filter(env_ts,dominanttree == "PICEMAR" )



env_bs <- as.data.frame(env_bs)

dim(env_bs)       

row.names(env_bs)<-env_bs$plotnumber
row.names(env_bs)

# sort the environment dataframe by row.names to match the vegetation data frame
env_bs <- env_bs[order(env_bs$plotnumber), ]

# Drop unused factors in the aggregated column
env_bs$soil_moisture_agg<-droplevels(env_bs$soil_moisture_agg)

```

### Create the vegetation data subset for black spruce plots in the Boreal Shield ecoregion

```{r}
veg_bs <- fec_vegfor[fec_vegfor$plotnumber %in% row.names(env_bs),] 

veg_bs_mat <-matrify(veg_bs[,c(1,3,5)])

dim(veg_bs_mat)


x11(pointsize=10) # opens a new graphics device
veg_bs_abuocc <- abuocc(veg_bs_mat,minabu=0,panel='all')

# calculate 1% of total number of plots  - rare taxa in this dataset
(dim(veg_bs_mat)[1])*0.01

# remove rare taxa (i.e., taxa that are in <1% of all plots)
veg_bs_mat_lt1 <- veg_bs_mat[,veg_bs_abuocc$plt.spc>1]  
dim(veg_bs_mat_lt1)

# confirm the veg and environment data frames are sorted the same (alphabetically by plot number)

identical(row.names(veg_bs_mat_lt1),row.names(veg_bs_mat_lt1))

```


### Dissimilarity and NMDS - raw abundance
```{r}

# Dissimilarity -- discuss other dissimilary/distance measures, perhaps use an example - Euclidean distance
veg_bs_mat_lt1_dist_bc <- vegdist(veg_bs_mat_lt1,method="bray") 

# raw cover
fec_upfor_bs_nmds_bc <-
  metaMDS(veg_bs_mat_lt1_dist_bc,
          distance = "bray",
          k = 3,
          maxit = 50, # number of iterations per attempt
          trymax = 10, # number of attempts
          wascores = TRUE)
fec_upfor_bs_nmds_bc

# Stress Plot - shows the actual distances in coordinate space vs. dissimilarity
x11()
stressplot(fec_upfor_bs_nmds_bc,main = "Stress Plot for Boreal Shield Black Spruce Forests\n Raw Abundance and Bray/Curtis") # Produces a Shepard's diagram
```
Stress refers to a measure of the goodness-of-fit or how well the non-metric multidimensional scaling (NMDS) ordination represents the original distances (or dissimilarities) between the samples (in this case plots) in a lower-dimensional space. Lower stress values indicate a better fit, meaning the ordination is a more accurate representation of the data. At the outset of analysis experiment with different abundance transformations (or no transformation) and dissimilarity metrics. Factors that affect stress include the number of dimensions selected, abundance transformation, dissimilarity/distance metric used, and the beta diversity of the dataset (higher diversity, higher stress). 

 As a rule of thumb literature has identified the following cut-off values for stress-level:

Higher than 0.2 is poor (risks for false interpretation).
* 0.1 - 0.2 is fair (some distances can be misleading for interpretation).
* 0.05 - 0.1 is good (can be confident in inferences from plot).
* Less than 0.05 is excellent (this can be rare).

Stress for the raw abundance was primarily ranged from 0.15 to 0.20 - on upper end the stress values.

### Plot Raw Abundance NMDS
```{r}
# plot the nmds (show dimensions 1 and 2)
x11()
plot(fec_upfor_bs_nmds_bc, "sites",choices = c(1, 2))

# plot the nmds (show dimensions 1 and 3)
x11()
plot(fec_upfor_bs_nmds_bc, "sites",choices = c(1, 3))

# plot sites
plot(fec_upfor_bs_nmds_bc, "sites",choices = c(1, 2))
orditorp(fec_upfor_bs_nmds_bc, "sites")

# Plot the NMDS dynamically and symbolize aggrgated moisture classes
veg_bs_nmds_bc_rgl <-ordirgl(fec_upfor_bs_nmds_bc, radius = .01, color="black")

# Identify plots
identify.rgl(env_bs$plotnumber,fec_upfor_bs_nmds_bc$points,1,2,3)

```

### Dissimilarity and NMDS - normalized (chord) species abundance
```{r}
# Normalized abundance transformation
veg_bs_mat_lt1_norm <-         
  decostand(veg_bs_mat_lt1, method = "normalize")

# Dissimilarity
veg_bs_mat_lt1_dist_bc_norm <- vegdist(veg_bs_mat_lt1_norm,method="bray") 

# Normalized cover
fec_upfor_bs_nmds_bc_norm <-
  metaMDS(veg_bs_mat_lt1_dist_bc_norm,
          distance = "bray",
          k = 3,
          maxit = 50, 
          trymax = 10,
          wascores = TRUE)
fec_upfor_bs_nmds_bc_norm

x11()
stressplot(fec_upfor_bs_nmds_bc_norm,main="Stress Plot for Boreal Shield Black Spruce Forests\n Normalized Abundance and Bray/Curtis") # Produces a Shepard's diagram

x11()
plot(fec_upfor_bs_nmds_bc_norm, "sites",choices = c(1, 2))
orditorp(fec_upfor_bs_nmds_bc_norm, "sites")

# Plot the NMDS dynamically and symbolize aggrgated moisture classes
veg_bs_nmds_bc_norm_rgl <-ordirgl(fec_upfor_bs_nmds_bc_norm, radius = .01, color="black")

# Identify plots
identify.rgl(env_bs$plotnumber,fec_upfor_bs_nmds_bc_norm$points,1,2,3)

veg_bs %>% 
  as_tibble() %>%
        filter(plotnumber %in% c(1719)) %>%
          arrange(desc(cover_percent),physiog_agg,analysis_name) %>%
            print(n=30)
```



### Explore the gradients in the ordination - Generalized Additive Models

```{r}
# Generalized Additive Models
x11()
plot(fec_upfor_bs_nmds_bc_norm, "sites",choices = c(1, 2))

# Elevation
plot(fec_upfor_bs_nmds_bc_norm, "sites",choices = c(1, 2))
surf_elev <- ordisurf(fec_upfor_bs_nmds_bc_norm,env_bs$elevation_m,choices = c(1, 2))
summary(surf_elev)

# Water table
plot(fec_upfor_bs_nmds_bc_norm, "sites",choices = c(1, 2))
surf_watertab <- ordisurf(fec_upfor_bs_nmds_bc_norm,env_bs$depth_to_water_table_cm,choices = c(1, 2))
summary(surf_watertab)

# Surface Water cover
plot(fec_upfor_bs_nmds_bc_norm, "sites",choices = c(1, 2))
surf_water <- ordisurf(fec_upfor_bs_nmds_bc_norm,env_bs$water,choices = c(1, 2))
summary(surf_water)

# Exposed mineral soil cover - Dimensions 1 and 2
plot(fec_upfor_bs_nmds_bc_norm, "sites",choices = c(1, 2))
surf_soil <- ordisurf(fec_upfor_bs_nmds_bc_norm,env_bs$soil,choices = c(1, 2))
summary(surf_soil)

# Exposed mineral soil cover - Dimensions 1 and 3
plot(fec_upfor_bs_nmds_bc_norm, "sites",choices = c(1, 3))
surf_soil_13 <- ordisurf(fec_upfor_bs_nmds_bc_norm,env_bs$soil,choices = c(1, 3))
summary(surf_soil_13)


# Depth of Surface Organics
plot(fec_upfor_bs_nmds_bc_norm, "sites",choices = c(1, 2))
surf_org <- ordisurf(fec_upfor_bs_nmds_bc_norm,env_bs$depth_of_organic_matter_cm,choices = c(1, 2))
summary(surf_org)

plot(fec_upfor_bs_nmds_bc_norm, "sites",choices = c(1, 3))
surf_org_1_3 <- ordisurf(fec_upfor_bs_nmds_bc_norm,env_bs$depth_of_organic_matter_cm,choices = c(1, 3))
summary(surf_org_1_3)

# Total live vascular cover
plot(fec_upfor_bs_nmds_bc_norm, "sites",choices = c(1, 2))
surf_live <- ordisurf(fec_upfor_bs_nmds_bc_norm,env_bs$laivascular,choices = c(1, 2))
summary(surf_live)

# Total cryptogram cover
plot(fec_upfor_bs_nmds_bc_norm, "sites",choices = c(1, 2))
surf_crypt <- ordisurf(fec_upfor_bs_nmds_bc_norm,env_bs$bryophytes_and_lichens,choices = c(1, 2))
summary(surf_crypt)

# Sphagnum cover
plot(fec_upfor_bs_nmds_bc_norm, "sites",choices = c(1, 2))
surf_sphag <- ordisurf(fec_upfor_bs_nmds_bc_norm,veg_bs_mat_lt1$Sphagnum,choices = c(1, 2))
summary(surf_sphag)

```

### Explore the gradients in the ordination - categorical variables

Soil moisture
```{r}

# Soil moisture

# Symbolize Aggregated Soil Moisture Classes on the Dynamic Ordination
fec_upfor_bs_nmds_bc_norm_rgl <-ordirgl(fec_upfor_bs_nmds_bc_norm, radius = .005, color="black")

orglpoints(fec_upfor_bs_nmds_bc_norm$points[env_bs$soil_moisture_agg=="Dry",],display="sites",color="red",radius=.010) 
orglpoints(fec_upfor_bs_nmds_bc_norm$points[env_bs$soil_moisture_agg=="Fresh",],display="sites",color="yellow",radius=.010) 
orglpoints(fec_upfor_bs_nmds_bc_norm$points[env_bs$soil_moisture_agg=="Moist",],display="sites",color="green",radius=.010) 
orglpoints(fec_upfor_bs_nmds_bc_norm$points[env_bs$soil_moisture_agg=="Wet",],display="sites",color="blue",radius=.010) 

# Test significance of the distribution of moisture classes along the ordination axes, this may take a few minutes to run
fec_upfor_bs_nmds_bc_norm_dsv <- nmds(veg_bs_mat_lt1_dist_bc_norm,k=3)
moist_test <- ordtest(fec_upfor_bs_nmds_bc_norm_dsv,env_bs$soil_moisture_agg)

```

```{r}

# Parent Material

# Test significance of the distribution of parent material along the ordination axes
fec_upfor_bs_nmds_bc_norm_dsv <- nmds(veg_bs_mat_lt1_dist_bc_norm,k=3)
pm_test <- ordtest(fec_upfor_bs_nmds_bc_norm_dsv,env_bs$parent_material_title)

```
 Slope Position
```{r}

# Slope Position

# Symbolize Aggregated Soil Moisture Classes on the Dynamic Ordination
fec_upfor_bs_nmds_bc_norm_rgl <-ordirgl(fec_upfor_bs_nmds_bc_norm, radius = .005, color="black")

orglpoints(fec_upfor_bs_nmds_bc_norm$points[env_bs$slope_position_title %in% ("Crest"),],display="sites",color="red",radius=.010) 
orglpoints(fec_upfor_bs_nmds_bc_norm$points[env_bs$slope_position_title %in% c("Lower Slope","Mid Slope","Upper Slope"),],display="sites",color="yellow",radius=.010) 
orglpoints(fec_upfor_bs_nmds_bc_norm$points[env_bs$slope_position_title %in% c("Toe Slope"),],display="sites",color="green",radius=.010) 
orglpoints(fec_upfor_bs_nmds_bc_norm$points[env_bs$slope_position_title %in% c("Depression", "Level"),],display="sites",color="blue",radius=.010) 

# Test significance of the distribution of moisture classes along the ordination axes, this may take a few minutes to run
fec_upfor_bs_nmds_bc_norm_dsv <- nmds(veg_bs_mat_lt1_dist_bc_norm,k=3)
slopepos_test <- ordtest(fec_upfor_bs_nmds_bc_norm_dsv,env_bs$slope_position_title)

```

### Correlation analysis

Calculate the correlations of each species with the 3 NMDS axes. This is a type of indirect gradient analysis. We can then sort the results by axis, looking at the species that have high positive and negative correlations with each axis. We can then apply our knowledge of the econormy of the species to help us understand the gradients represented by the ordination axes.

```{r}
# Correlation analysis

fec_upfor_m_sppcor_norm <-
  cor(veg_bs_mat_lt1_norm,
      fec_upfor_bs_nmds_bc_norm$points,
      use = "complete.obs",
      method = "pearson")

# Sort by NMDS axis 1
fec_upfor_m_sppcor_norm <- fec_upfor_m_sppcor_norm[order(fec_upfor_m_sppcor_norm[,1],decreasing = TRUE),] 

write.csv(fec_upfor_m_sppcor_norm, file = "tables/fec_upfor_sppcor_m_norm_PearsonCor.csv")

```

Next, open the csv file that we created and review the results.

## Cluster Analysis

### Partitioning Around Medoids (PAM) - K-medoids clustering - norm transformed


```{r}
# Evaluate the average within to between cluster similar ratio (silhouette width) for a variety of cluster numbers, this may take a few minutes

fec_vegfor_norm_pamsel<-pam.select(veg_bs_mat_lt1_dist_bc_norm,k=30)
fec_vegfor_norm_pamsel
plot(fec_vegfor_norm_pamsel)

```

The three cluster classification maximized the average silhouette width.

```{r}
# Create 3 cluster classification
fec_vegfor_norm_pam_3 <- pam(veg_bs_mat_lt1_dist_bc_norm,k=3)
attributes(fec_vegfor_norm_pam_3)
x11()
plot(fec_vegfor_norm_pam_3)

```

A secondary spike in silwidth occurred at 10 clusters

```{r}
# Create 10 cluster classification
fec_vegfor_norm_pam_10 <- pam(veg_bs_mat_lt1_dist_bc_norm,k=10)
attributes(fec_vegfor_norm_pam_10)
x11()
plot(fec_vegfor_norm_pam_10)

```

##################################################################################################################
## Hierarchical Clustering using hclust 
##################################################################################################################

```{r}

# Create clustering and plot the dendrogram
fec_vegfor_norm_hclust_ward <- hclust(veg_bs_mat_lt1_dist_bc_norm, method = 'ward.D2') 

x11()
plot(fec_vegfor_norm_hclust_ward, xlab = "Hierarchical Clustering - Ward")

```

### Explore the clusters 
```{r}
## Constancy/cover Cluster 1
const_abund(veg_bs_mat_lt1,fec_vegfor_norm_pam_3,clusnum = 1,const_thresh=60)

## Constancy/cover Cluster 2
const_abund(veg_bs_mat_lt1,fec_vegfor_norm_pam_3,clusnum = 2,const_thresh=60)

## Constancy/cover Cluster 3
const_abund(veg_bs_mat_lt1,fec_vegfor_norm_pam_3,clusnum = 3,const_thresh=60)

```

### Explore the PAM 10 cluster classification 
```{r}
## Constancy/cover Cluster 1
const_abund(veg_bs_mat_lt1,fec_vegfor_norm_pam_10,clusnum = 1,const_thresh=60)

## Constancy/cover Cluster 2
const_abund(veg_bs_mat_lt1,fec_vegfor_norm_pam_10,clusnum = 2,const_thresh=60)

## Constancy/cover Cluster 3
const_abund(veg_bs_mat_lt1,fec_vegfor_norm_pam_10,clusnum = 3,const_thresh=60)

## Constancy/cover Cluster 4
const_abund(veg_bs_mat_lt1,fec_vegfor_norm_pam_10,clusnum = 4,const_thresh=60)

# Etc... for all clusters

```

### Partition analysis

```{r}

## Partition analysis
veg_bs_pam10_part <- partana(fec_vegfor_norm_pam_10$clustering,veg_bs_mat_lt1_dist_bc_norm)
plot(veg_bs_pam10_part)

# Cluster to cluster similarity matrix
write.csv(veg_bs_pam10_part$ctc,file='tables/veg_bs_pam10_part$ctc.csv')


# Plot to cluster similarity matrix

row.names(veg_bs_pam10_part$ptc)<- env_bs$plotnumber
write.csv(veg_bs_pam10_part$ptc,file='tables/veg_bs_pam10_part$ptc.csv')


```


